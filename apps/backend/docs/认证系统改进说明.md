# è®¤è¯ç³»ç»Ÿæ”¹è¿›è¯´æ˜

## æ”¹è¿›æ¦‚è¿°

æœ¬æ¬¡æ”¹è¿›å°†åŸæœ‰çš„demoçº§åˆ«ç™»å½•æ³¨å†ŒåŠŸèƒ½å‡çº§ä¸ºç”Ÿäº§çº§åˆ«çš„è®¤è¯ç³»ç»Ÿ,å¼•å…¥äº†JWTã€å¯†ç åŠ å¯†ã€å‚æ•°éªŒè¯ã€ç»Ÿä¸€å¼‚å¸¸å¤„ç†ç­‰å®Œæ•´çš„ä¼ä¸šçº§ç‰¹æ€§ã€‚

---

## ä¸»è¦æ”¹è¿›å†…å®¹

### 1. JWTè®¤è¯ç³»ç»Ÿ âœ¨

#### æ”¹è¿›å‰
- æ— tokenæœºåˆ¶
- æ— ä¼šè¯ç®¡ç†
- ç™»å½•çŠ¶æ€æ— æ³•æŒä¹…åŒ–

#### æ”¹è¿›å
- âœ… é›†æˆ `@nestjs/jwt` å’Œ `passport-jwt`
- âœ… å®ç°JWTç­–ç•¥ (`JwtStrategy`)
- âœ… åˆ›å»ºJWTè®¤è¯å®ˆå« (`JwtAuthGuard`)
- âœ… Tokenè‡ªåŠ¨è¿‡æœŸç®¡ç†
- âœ… æ”¯æŒBearer Tokenè®¤è¯
- âœ… æä¾› `@Public()` è£…é¥°å™¨æ ‡è®°å…¬å¼€æ¥å£
- âœ… æä¾› `@CurrentUser()` è£…é¥°å™¨è·å–å½“å‰ç”¨æˆ·

**æ–‡ä»¶ä½ç½®**:
- `src/modules/auth/strategies/jwt.strategy.ts`
- `src/modules/auth/guards/jwt-auth.guard.ts`
- `src/modules/auth/decorators/public.decorator.ts`
- `src/modules/auth/decorators/current-user.decorator.ts`
- `src/modules/auth/auth.module.ts`

---

### 2. å¯†ç å®‰å…¨ ğŸ”

#### æ”¹è¿›å‰
```typescript
// æ˜æ–‡å­˜å‚¨å¯†ç 
password: string

// æ˜æ–‡æ¯”å¯¹
return user.password === loginDto.password
```

#### æ”¹è¿›å
```typescript
// ä½¿ç”¨bcryptåŠ å¯†
const hashedPassword = await bcrypt.hash(password, saltRounds);

// å®‰å…¨æ¯”å¯¹
const isValid = await bcrypt.compare(password, hashedPassword);
```

- âœ… ä½¿ç”¨ `bcrypt` åŠ å¯†å¯†ç 
- âœ… å¯é…ç½®åŠ å¯†å¼ºåº¦ (salt rounds)
- âœ… å¯†ç æ°¸ä¸æ˜æ–‡å­˜å‚¨
- âœ… å“åº”ä¸­ä¸è¿”å›å¯†ç å­—æ®µ

---

### 3. å‚æ•°éªŒè¯ âœ”ï¸

#### æ”¹è¿›å‰
- æ— å‚æ•°éªŒè¯
- å¯ä»¥ä¼ å…¥ä»»æ„æ•°æ®
- å®¹æ˜“å¯¼è‡´æ•°æ®åº“é”™è¯¯

#### æ”¹è¿›å
```typescript
export class CreateUserDto {
  @IsNotEmpty({ message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º' })
  @MinLength(2, { message: 'ç”¨æˆ·åè‡³å°‘2ä¸ªå­—ç¬¦' })
  @MaxLength(20, { message: 'ç”¨æˆ·åæœ€å¤š20ä¸ªå­—ç¬¦' })
  username: string;

  @IsEmail({}, { message: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' })
  email: string;

  @MinLength(6, { message: 'å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦' })
  @Matches(/^(?=.*[A-Za-z])(?=.*\d)/, {
    message: 'å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—',
  })
  password: string;
}
```

- âœ… ä½¿ç”¨ `class-validator` è¿›è¡ŒéªŒè¯
- âœ… å‹å¥½çš„ä¸­æ–‡é”™è¯¯æç¤º
- âœ… è‡ªåŠ¨å‚æ•°ç±»å‹è½¬æ¢
- âœ… é˜²æ­¢é¢å¤–å­—æ®µæ±¡æŸ“
- âœ… å…¨å±€éªŒè¯ç®¡é“

**æ”¹è¿›çš„DTO**:
- `CreateUserDto`: æ³¨å†Œå‚æ•°éªŒè¯
- `LoginDto`: ç™»å½•å‚æ•°éªŒè¯
- `UserResponseDto`: ç»Ÿä¸€å“åº”æ ¼å¼
- `LoginResponseDto`: ç™»å½•å“åº”æ ¼å¼

---

### 4. ç»Ÿä¸€å“åº”æ ¼å¼ ğŸ“¦

#### æ”¹è¿›å‰
```typescript
// å“åº”æ ¼å¼ä¸ç»Ÿä¸€
return user
return { code: 0, mes: "æˆåŠŸ" }
return "é”™è¯¯ä¿¡æ¯"
```

#### æ”¹è¿›å
```typescript
// æˆåŠŸå“åº”
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "success": true,
  "data": { ... }
}

// é”™è¯¯å“åº”
{
  "code": 400,
  "message": "å…·ä½“é”™è¯¯ä¿¡æ¯",
  "success": false,
  "timestamp": "2025-01-01T00:00:00.000Z"
}
```

- âœ… å“åº”æ‹¦æˆªå™¨ (`ResponseInterceptor`)
- âœ… ç»Ÿä¸€çš„æˆåŠŸå“åº”æ ¼å¼
- âœ… ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- âœ… è‡ªåŠ¨å¤„ç†æ‰€æœ‰å“åº”

---

### 5. å¼‚å¸¸å¤„ç† ğŸš¨

#### æ”¹è¿›å‰
```typescript
if (!user) {
  return 'è¯¥é‚®ç®±æœªæ³¨å†Œ'
}
```

#### æ”¹è¿›å
```typescript
if (!user) {
  throw new BusinessException('è¯¥é‚®ç®±æœªæ³¨å†Œ', HttpStatus.NOT_FOUND);
}
```

- âœ… å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ (`HttpExceptionFilter`)
- âœ… ä¸šåŠ¡å¼‚å¸¸ç±» (`BusinessException`)
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… å‹å¥½çš„é”™è¯¯æç¤º

---

### 6. ä»£ç æ¶æ„ä¼˜åŒ– ğŸ—ï¸

#### Serviceå±‚æ”¹è¿›

**æ”¹è¿›å‰**:
```typescript
async createUser(user: createUserDto, userModel: Model<any>) {
  userModel.create(user)  // æ— è¿”å›å€¼,æ— é”™è¯¯å¤„ç†
  return user
}
```

**æ”¹è¿›å**:
```typescript
async createUser(createUserDto: CreateUserDto): Promise<UserResponseDto> {
  try {
    // 1. æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
    const existingUser = await this.userModel.findOne({ email });
    if (existingUser) {
      throw new BusinessException('é‚®ç®±å·²è¢«æ³¨å†Œ');
    }

    // 2. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
    const existingUsername = await this.userModel.findOne({ username });
    if (existingUsername) {
      throw new BusinessException('ç”¨æˆ·åå·²è¢«ä½¿ç”¨');
    }

    // 3. åŠ å¯†å¯†ç 
    const hashedPassword = await bcrypt.hash(password, saltRounds);

    // 4. åˆ›å»ºç”¨æˆ·
    const newUser = await this.userModel.create({...});

    // 5. è®°å½•æ—¥å¿—
    this.logger.log(`ç”¨æˆ·æ³¨å†ŒæˆåŠŸ: ${email}`);

    // 6. è¿”å›ç»“æœ(ä¸å«å¯†ç )
    return {...};
  } catch (error) {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
  }
}
```

æ”¹è¿›ç‚¹:
- âœ… ä¾èµ–æ³¨å…¥ä¼˜åŒ–,ä¸å†ä¼ é€’ Model
- âœ… å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘æ ¡éªŒ
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- âœ… ç±»å‹å®‰å…¨çš„è¿”å›å€¼
- âœ… å“åº”ä¸­ä¸è¿”å›æ•æ„Ÿä¿¡æ¯

#### Controllerå±‚æ”¹è¿›

**æ”¹è¿›å‰**:
```typescript
@Post('/register')
async register(@Body() newUser: createUserDto) {
  const res = await this.userService.createUser(newUser, this.userModel)
  return {
    code: 0,
    message: 'ç”¨æˆ·æ³¨å†ŒæˆåŠŸ',
    data: res
  }
}
```

**æ”¹è¿›å**:
```typescript
@Controller('api/users')
@UseGuards(JwtAuthGuard)  // å…¨å±€å®ˆå«
export class UserController {
  @Public()  // å…¬å¼€æ¥å£
  @Post('/register')
  @HttpCode(HttpStatus.CREATED)
  async register(
    @Body(new ValidationPipe({ ... })) createUserDto: CreateUserDto,
  ) {
    return await this.userService.createUser(createUserDto);
  }

  @Get('/profile')  // éœ€è¦è®¤è¯
  async getProfile(@CurrentUser() user: CurrentUserType) {
    return await this.userService.findById(user.userId);
  }
}
```

æ”¹è¿›ç‚¹:
- âœ… ä½¿ç”¨JWTå®ˆå«ä¿æŠ¤æ‰€æœ‰æ¥å£
- âœ… `@Public()` æ ‡è®°å…¬å¼€æ¥å£
- âœ… `@CurrentUser()` è·å–å½“å‰ç”¨æˆ·
- âœ… å‚æ•°è‡ªåŠ¨éªŒè¯
- âœ… æ ‡å‡†HTTPçŠ¶æ€ç 
- âœ… ç®€åŒ–æ§åˆ¶å™¨é€»è¾‘

---

### 7. é…ç½®ç®¡ç† âš™ï¸

#### æ”¹è¿›å‰
- ç¡¬ç¼–ç é…ç½®
- æ— ç¯å¢ƒå˜é‡æ”¯æŒ

#### æ”¹è¿›å
- âœ… ä½¿ç”¨ `@nestjs/config`
- âœ… æ”¯æŒ `.env` æ–‡ä»¶
- âœ… ç±»å‹å®‰å…¨çš„é…ç½®è®¿é—®
- âœ… åˆ†ç¦»çš„é…ç½®æ¨¡å—
- âœ… å…¨å±€é…ç½®å¯ç”¨

**é…ç½®æ–‡ä»¶**:
- `src/config/jwt.config.ts`: JWTé…ç½®
- `src/config/app.config.ts`: åº”ç”¨é…ç½®

---

### 8. æ–°å¢åŠŸèƒ½ ğŸ¯

#### ç”¨æˆ·ç®¡ç†æ¥å£
- âœ… `GET /api/users/profile`: è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- âœ… `GET /api/users`: è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
- âœ… `GET /api/users/:id`: æ ¹æ®IDè·å–ç”¨æˆ·
- âœ… æ‰€æœ‰æ¥å£éƒ½éœ€è¦JWTè®¤è¯(é™¤äº†ç™»å½•æ³¨å†Œ)

#### å®‰å…¨å¢å¼º
- âœ… é‚®ç®±å”¯ä¸€æ€§æ ¡éªŒ
- âœ… ç”¨æˆ·åå”¯ä¸€æ€§æ ¡éªŒ
- âœ… å¯†ç å¼ºåº¦éªŒè¯
- âœ… Tokenè‡ªåŠ¨è¿‡æœŸ
- âœ… é˜²æ­¢å¯†ç æ³„éœ²

---

## æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ common/                        # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ exceptions/
â”‚   â”‚   â””â”€â”€ business.exception.ts  # ä¸šåŠ¡å¼‚å¸¸ç±»
â”‚   â”œâ”€â”€ filters/
â”‚   â”‚   â””â”€â”€ http-exception.filter.ts  # å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â””â”€â”€ interceptors/
â”‚       â””â”€â”€ response.interceptor.ts   # å“åº”æ‹¦æˆªå™¨
â”‚
â”œâ”€â”€ config/                        # é…ç½®æ¨¡å—
â”‚   â”œâ”€â”€ jwt.config.ts              # JWTé…ç½®
â”‚   â””â”€â”€ app.config.ts              # åº”ç”¨é…ç½®
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ auth/                      # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ strategies/
â”‚   â”‚   â”‚   â””â”€â”€ jwt.strategy.ts    # JWTç­–ç•¥
â”‚   â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â”‚   â””â”€â”€ jwt-auth.guard.ts  # JWTå®ˆå«
â”‚   â”‚   â”œâ”€â”€ decorators/
â”‚   â”‚   â”‚   â”œâ”€â”€ public.decorator.ts      # å…¬å¼€æ¥å£è£…é¥°å™¨
â”‚   â”‚   â”‚   â””â”€â”€ current-user.decorator.ts # å½“å‰ç”¨æˆ·è£…é¥°å™¨
â”‚   â”‚   â””â”€â”€ auth.module.ts         # è®¤è¯æ¨¡å—
â”‚   â”‚
â”‚   â””â”€â”€ Users/                     # ç”¨æˆ·æ¨¡å—(å·²é‡æ„)
â”‚       â”œâ”€â”€ user.controller.ts     # ç”¨æˆ·æ§åˆ¶å™¨
â”‚       â”œâ”€â”€ user.service.ts        # ç”¨æˆ·æœåŠ¡
â”‚       â”œâ”€â”€ user.module.ts         # ç”¨æˆ·æ¨¡å—
â”‚       â””â”€â”€ user.provider.ts       # ç”¨æˆ·æä¾›è€…
â”‚
â”œâ”€â”€ DTO/
â”‚   â””â”€â”€ userDto.ts                 # ç”¨æˆ·DTO(å·²é‡æ„)
â”‚
â”œâ”€â”€ app.module.ts                  # åº”ç”¨ä¸»æ¨¡å—(å·²æ›´æ–°)
â””â”€â”€ main.ts                        # åº”ç”¨å…¥å£(å·²æ›´æ–°)
```

---

## æŠ€æœ¯æ ˆ

### æ–°å¢ä¾èµ–
- `@nestjs/jwt`: JWTæ”¯æŒ
- `@nestjs/passport`: Passportè®¤è¯
- `@nestjs/config`: é…ç½®ç®¡ç†
- `passport-jwt`: JWTç­–ç•¥
- `bcrypt`: å¯†ç åŠ å¯†
- `class-validator`: å‚æ•°éªŒè¯
- `class-transformer`: ç±»å‹è½¬æ¢

### ç±»å‹å®šä¹‰
- `@types/bcrypt`
- `@types/passport-jwt`

---

## ä½¿ç”¨æ–¹æ³•

### 1. é…ç½®ç¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶:

```env
PORT=3000
MONGODB_URI=mongodb://localhost:27017/nebula-nest
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=7d
BCRYPT_SALT_ROUNDS=10
```

### 2. å¯åŠ¨åº”ç”¨

```bash
npm run dev
```

### 3. æµ‹è¯•æ¥å£

æŸ¥çœ‹ `docs/APIä½¿ç”¨æŒ‡å—.md` äº†è§£è¯¦ç»†çš„APIä½¿ç”¨æ–¹æ³•ã€‚

---

## æœ€ä½³å®è·µ

### 1. å¯†ç å®‰å…¨
- âœ… æ°¸ä¸æ˜æ–‡å­˜å‚¨å¯†ç 
- âœ… ä½¿ç”¨bcryptåŠ å¯†
- âœ… å“åº”ä¸­ä¸è¿”å›å¯†ç 
- âœ… éªŒè¯å¯†ç å¼ºåº¦

### 2. Tokenç®¡ç†
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥
- âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- âœ… ä½¿ç”¨Bearer Tokenæ ¼å¼
- âœ… Tokenå¤±æ•ˆè‡ªåŠ¨æ‹¦æˆª

### 3. é”™è¯¯å¤„ç†
- âœ… ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†
- âœ… å‹å¥½çš„é”™è¯¯æç¤º
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… ä¸æš´éœ²æ•æ„Ÿä¿¡æ¯

### 4. æ•°æ®éªŒè¯
- âœ… ä½¿ç”¨DTOè¿›è¡Œç±»å‹å®šä¹‰
- âœ… ä½¿ç”¨è£…é¥°å™¨è¿›è¡ŒéªŒè¯
- âœ… æä¾›æ¸…æ™°çš„éªŒè¯æ¶ˆæ¯
- âœ… é˜²æ­¢é¢å¤–å­—æ®µæ±¡æŸ“

### 5. ä»£ç ç»„ç»‡
- âœ… æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†
- âœ… å•ä¸€èŒè´£åŸåˆ™
- âœ… ä¾èµ–æ³¨å…¥
- âœ… ç±»å‹å®‰å…¨

---

## å®‰å…¨ç‰¹æ€§

1. **å¯†ç åŠ å¯†**: ä½¿ç”¨bcryptåŠ å¯†,ä¸å¯é€†
2. **JWTè®¤è¯**: æ— çŠ¶æ€è®¤è¯,å¯æ‰©å±•
3. **å‚æ•°éªŒè¯**: é˜²æ­¢æ³¨å…¥æ”»å‡»
4. **CORSé…ç½®**: è·¨åŸŸå®‰å…¨
5. **é”™è¯¯éšè—**: ä¸æš´éœ²å†…éƒ¨é”™è¯¯
6. **å”¯ä¸€æ€§æ ¡éªŒ**: é˜²æ­¢é‡å¤æ³¨å†Œ
7. **Tokenè¿‡æœŸ**: è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶
8. **æ—¥å¿—è®°å½•**: å®¡è®¡è¿½è¸ª

---

## åç»­å¯æ‰©å±•åŠŸèƒ½

- [ ] åˆ·æ–°Tokenæœºåˆ¶
- [ ] é‚®ç®±éªŒè¯
- [ ] å¿˜è®°å¯†ç /é‡ç½®å¯†ç 
- [ ] ç”¨æˆ·è§’è‰²å’Œæƒé™ç®¡ç†
- [ ] å¤šå› ç´ è®¤è¯(2FA)
- [ ] ç™»å½•é™æµå’Œé˜²æš´åŠ›ç ´è§£
- [ ] OAuthç¬¬ä¸‰æ–¹ç™»å½•
- [ ] Sessionç®¡ç†
- [ ] ç”¨æˆ·æ´»åŠ¨æ—¥å¿—

---

## æ€»ç»“

æœ¬æ¬¡æ”¹è¿›å°†åŸæœ‰çš„ç®€å•demoå‡çº§ä¸ºä¼ä¸šçº§è®¤è¯ç³»ç»Ÿ,å…·å¤‡:
- âœ… å®Œæ•´çš„JWTè®¤è¯æœºåˆ¶
- âœ… å®‰å…¨çš„å¯†ç åŠ å¯†
- âœ… ä¸¥æ ¼çš„å‚æ•°éªŒè¯
- âœ… ç»Ÿä¸€çš„å“åº”å’Œå¼‚å¸¸å¤„ç†
- âœ… è‰¯å¥½çš„ä»£ç æ¶æ„
- âœ… ç”Ÿäº§çº§åˆ«çš„å®‰å…¨æ€§

ç³»ç»Ÿç°åœ¨å·²ç»å¯ä»¥ç”¨äºå®é™…é¡¹ç›®å¼€å‘! ğŸ‰

