## 目标与原则
- 在不摒弃现有“模板区域拖拽渲染”的前提下，新增“全屏自由拖拽”布局能力。
- 复用现有图表模型与渲染（ECharts + `Render`），保持组件库、属性面板、状态管理的一致性。
- 模式可切换：`模板模式` 与 `自由模式`，互不影响、可分别保存/加载。

## 现状概要（基于代码）
- 拖拽来源：侧栏组件卡片在 `onDragStart` 写入 `dataTransfer`（`ComponentsChooser.tsx:76-79`）。
- 落点：模板区域在 `dragover/drop` 读取并注册到状态（`TemplateContainer.tsx:25-56`）。
- 渲染：按区域 `id` 从注册表取配置并 `echarts.setOption`（`Render.tsx:18-49`）。
- 状态：注册表 `Map<string, ChartAttribute>` 与当前选中区域（`componentsRegistry.ts:31-89`）。

## 总体设计
- 引入“布局模式”枚举：`template | free`，在编辑器主组件维护 `layoutMode` 状态；切换时切换画布组件。
- 通用“放置位”概念：把 `componentsRegistry` 的键从“区域 id”泛化为“放置位 id”（区域或自由项）。属性面板和渲染都只依赖此 id。
- 新增“自由画布层”与“自由项”数据结构，支持绝对定位、拖拽移动、缩放与吸附。

## 关键数据结构
- `FreeItem`: `{ id, x, y, w, h, z, locked }`（单位默认 px，支持吸附到 `gridSize`）。
- `FreeLayout`: `FreeItem[]`（按 z 顺序渲染）。
- `ScreenInstance`: `{ mode: 'template'|'free', template?: ScreenTemplate, freeLayout?: FreeLayout, registry: Record<placementId, ChartAttribute|null> }`。

## 组件与状态改造
- 编辑器主组件（`src/components/Editor/Index.tsx`）
  - 新增 `layoutMode` 与切换 UI；当为 `template` 时渲染 `TemplateContainer`，为 `free` 时渲染 `FreeCanvas`。
  - 点击/选择逻辑扩展为“当前放置位”，不再仅限区域。
- 注册表（`src/store/componentsRegistry.ts`）
  - 保持 `Map<string, ChartAttribute>` 不变，只是键的语义从“区域 id”扩展为“放置位 id”。
  - 扩展 `currentArea` 为更通用的 `currentPlacement`（内容相同，指向区域或自由项）。
- 侧栏组件选择（`ComponentsChooser.tsx`）
  - 保持 `onDragStart`（`ComponentsChooser.tsx:76-79`）；为更稳定的拖拽体验，建议给卡片容器加 `draggable` 属性（当前未设置）。

## 自由画布 FreeCanvas（新增组件）
- 容器：全屏绝对定位，支持背景、网格线显示（与 `TemplateContainer` 的网格视觉保持一致）。
- 放置：在 `dragover/drop` 内创建 `FreeItem`，以鼠标落点初始化 `x/y`，`w/h` 可给默认尺寸。随后写入注册表：`setComponentsRegistry(freeItem.id, chartOptions)`。
- 渲染：每个 `FreeItem` 内部复用 `<Render id={freeItem.id} />`。
- 交互：
  - 移动：`pointerdown → pointermove → pointerup`，更新 `x/y`；支持吸附到 `gridSize`（例如 8/10/16 px）。
  - 缩放：四角/边缘句柄更新 `w/h`；同样执行吸附。
  - 选择：点击高亮当前项，驱动属性面板；支持 `locked` 禁止交互。
  - 叠放：维护 `z`，支持“置顶/置底”。

## 吸附与对齐
- 网格吸附：`round(value / gridSize) * gridSize` 应用于 `x/y/w/h`。
- 辅助线：在移动/缩放接近其他项边缘或画布中心线时显示临时参考线（可后续迭代）。

## 属性面板复用
- 复用现有 `SettingBar`，依据 `currentPlacement` 展示并编辑图表配置。
- 自由项的几何属性（`x/y/w/h/z/locked`）可在面板新增基础表单项。

## 保存/加载（后续落地）
- 后端尚未落地项目/布局接口（检索结果）。可依据已有 `ProjectSchema` 扩展：
  - `POST /api/projects`：保存 `ScreenInstance`。
  - `GET /api/projects/:id`：加载。
  - `PUT /api/projects/:id`：更新。
- 前端新增 `src/api/projects.ts` 并在编辑器提供保存/加载入口。

## 兼容与迁移
- 模板模式保持现状（`TemplateContainer.tsx:127-172` 初始化/重置注册表逻辑不变）。
- 注册表键名不变：区域 id 与自由项 id 在同一空间，互不冲突即可（例如 `area-1` 与 `free-uuid`）。
- 渲染层完全复用 `Render`（`Render.tsx:16-49, 55-88`）。

## 增量实施顺序
1. 在 `Editor/Index.tsx` 引入 `layoutMode` 与切换按钮，跑通两套画布切换；`free` 先渲染静态空画布。
2. 新增 `FreeCanvas` 与 `FreeItem` 数据结构；完成 `drop → 创建项 → 注册 → Render` 的最小闭环。
3. 加入移动/缩放与网格吸附；扩展 `currentPlacement` 与属性面板读写。
4. 叠放/锁定/删除/复制等基础操作；完善光标与视觉反馈。
5. 保存/加载到本地或后端接口；完善项目列表与路由。

## 可选库（如需更稳交互）
- `@dnd-kit/core`（拖拽）+ `@dnd-kit/sortable`（排序，仅对列表适用）或 `interactjs`（拖拽/缩放手感佳）。
- 由于当前实现完全基于原生事件，首版可不引库，后续根据体验再引入（使用 `pnpm add`，命令在 `cmd` 里执行）。

## 验证点
- 自由模式：能把侧栏组件拖入任意位置，移动/缩放生效，`Render` 正常工作。
- 模板模式：现有区域拖拽与渲染不受影响；模式切换不会污染彼此的注册表内容。
- 保存/加载：能正确恢复画布与组件配置。

## 参考代码定位
- 拖拽源：`apps/frontend/src/components/Editor/Tools/ComponentsChooser.tsx:76-79`
- 落点与注册：`apps/frontend/src/components/Editor/Template/TemplateContainer.tsx:25-56, 127-136`
- 渲染：`apps/frontend/src/components/Editor/Render.tsx:16-49, 55-88`
- 状态：`apps/frontend/src/store/componentsRegistry.ts:31-89`
