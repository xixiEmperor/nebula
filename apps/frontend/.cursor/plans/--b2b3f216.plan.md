<!-- b2b3f216-3099-4e3a-a0c4-0a8810bbf77a c14a5ce3-ea39-461d-bb94-cfd175dcc028 -->
# NebulaScreen 大屏可视化平台升级方案

## 一、升级目标

基于当前项目架构，实现以下核心功能升级：

1. **空模板支持** - 提供完全自由的画布，支持自由拖拽和定位
2. **基础组件扩展** - 新增文本、图片、容器等常规组件
3. **数据请求配置** - 支持组件级别的API数据绑定
4. **项目导出功能** - 导出为可独立运行的React项目

## 二、技术架构分析

### 2.1 现有架构概览

当前系统采用以下核心架构：

```typescript
// 核心数据流
用户操作 → componentsRegistry(Zustand) → TemplateContainer → Render(ECharts)
         ↓
    SettingBar(配置面板)
```

**关键文件**：

- `src/types/template.ts` - 模板和区域类型定义
- `src/types/components.ts` - 组件属性类型定义
- `src/store/componentsRegistry.ts` - 组件注册中心（Zustand）
- `src/components/Editor/Template/TemplateContainer.tsx` - 模板容器
- `src/components/Editor/Render.tsx` - 图表渲染器

### 2.2 现有模板系统

当前模板基于**CSS Grid固定布局**：

- 预定义网格（gridRows × gridCols）
- 固定的区域位置（x, y, w, h）
- 只能在预设区域内放置组件

## 三、详细升级方案

### 3.1 空模板功能（优先级：高）

#### 3.1.1 设计思路

在现有模板系统基础上，新增一种**自由布局模板**类型：

```typescript
// 新增模板类型
interface FreeLayoutTemplate extends ScreenTemplate {
  layoutMode: 'free';  // 标识为自由布局
  canvasWidth: number;  // 画布宽度（px）
  canvasHeight: number; // 画布高度（px）
}

// 扩展区域类型，支持自由定位
interface FreeLayoutArea extends TemplateArea {
  position: 'absolute';
  left: number;   // 像素值
  top: number;    // 像素值
  width: number;  // 像素值
  height: number; // 像素值
  zIndex?: number;
}
```

#### 3.1.2 实现步骤

**Step 1**: 扩展模板类型定义

- 文件：`src/types/template.ts`
- 添加 `layoutMode` 字段（'grid' | 'free'）
- 扩展 `TemplateArea` 支持绝对定位属性

**Step 2**: 创建空模板配置

- 文件：`src/config/templates.ts`
- 新增 `emptyFreeTemplate` 配置
- 初始为空白画布（1920×1080）

**Step 3**: 修改 TemplateContainer 组件

- 文件：`src/components/Editor/Template/TemplateContainer.tsx`
- 根据 `layoutMode` 渲染不同布局容器
- Grid模式：保持现有CSS Grid
- Free模式：使用绝对定位容器

**Step 4**: 实现自由拖拽机制

- 使用原生拖拽API或 `react-dnd`
- 拖拽结束时计算组件位置（clientX/Y）
- 动态创建新区域并注册到 componentsRegistry

**Step 5**: 添加动态区域创建功能

```typescript
// 用户拖拽组件到空白区域时
function createDynamicArea(dropPosition: {x: number, y: number}, componentSize: {w: number, h: number}) {
  const newArea: FreeLayoutArea = {
    id: `area-${Date.now()}`,
    name: '自定义区域',
    position: 'absolute',
    left: dropPosition.x,
    top: dropPosition.y,
    width: componentSize.w || 400,
    height: componentSize.h || 300,
  };
  return newArea;
}
```

#### 3.1.3 交互细节

1. **拖拽预览**：显示半透明的组件轮廓
2. **吸附对齐**：可选开启网格吸附（如8px网格）
3. **调整尺寸**：选中组件后显示拖拽手柄，支持8个方向调整
4. **参考线**：拖拽时显示对齐参考线

### 3.2 基础组件扩展（优先级：高）

#### 3.2.1 新增组件列表

| 组件类型 | 组件ID | 功能说明 | 配置项 |

|---------|--------|---------|--------|

| 文本组件 | `basic.text` | 静态/动态文本显示 | 内容、字体、颜色、对齐 |

| 标题组件 | `basic.title` | 标题文字（大号） | 内容、级别、样式 |

| 图片组件 | `basic.image` | 图片展示 | URL、尺寸、圆角 |

| 时间显示 | `basic.time` | 实时时间 | 格式、时区 |

| 滚动文字 | `basic.marquee` | 跑马灯文本 | 内容、速度、方向 |

| 容器框 | `basic.container` | 可放置子组件的容器 | 背景、边框、内边距 |

#### 3.2.2 组件实现结构

```typescript
// 基础组件统一接口
interface BasicComponentProps {
  id: string;
  content?: string;
  style?: React.CSSProperties;
  className?: string;
}

// 示例：文本组件
interface TextComponentProps extends BasicComponentProps {
  fontSize?: number;
  color?: string;
  fontWeight?: string;
  textAlign?: 'left' | 'center' | 'right';
}
```

#### 3.2.3 文件组织

```
src/components/Editor/BasicComponents/
├── Text.tsx          # 文本组件
├── Title.tsx         # 标题组件
├── Image.tsx         # 图片组件
├── Time.tsx          # 时间组件
├── Marquee.tsx       # 滚动文字
├── Container.tsx     # 容器组件
└── index.ts          # 统一导出
```

#### 3.2.4 集成到组件选择器

- 文件：`src/components/Editor/Tools/ComponentsChooser.tsx`
- 新增 "基础组件" 分类tab
- 配置文件：`src/config/basic_components.ts`
- 缩略图：`src/assets/thumbs/basic-components/`

### 3.3 数据请求配置（优先级：中）

#### 3.3.1 数据源配置结构

```typescript
// 扩展组件属性，支持数据源配置
interface DataSourceConfig {
  enabled: boolean;           // 是否启用数据源
  type: 'api' | 'static';     // 数据类型
  apiConfig?: {
    url: string;              // API地址
    method: 'GET' | 'POST' | 'PUT';
    headers?: Record<string, string>;
    params?: Record<string, any>;
    body?: Record<string, any>;
    refreshInterval?: number; // 刷新间隔（秒）
  };
  dataMapping?: {             // 数据映射配置
    [chartField: string]: string; // ECharts字段 -> API响应路径
  };
  transform?: string;         // 数据转换函数（JS代码字符串）
}

// 扩展 ConponentsAttribute
interface ConponentsAttribute {
  // ... 现有字段
  dataSource?: DataSourceConfig;
}
```

#### 3.3.2 实现步骤

**Step 1**: 扩展类型定义

- 文件：`src/types/components.ts`
- 添加 `DataSourceConfig` 接口
- 更新 `ConponentsAttribute`

**Step 2**: 创建数据请求管理Hook

- 文件：`src/hooks/useDataSource.ts`
```typescript
function useDataSource(config: DataSourceConfig) {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  
  useEffect(() => {
    if (!config.enabled || !config.apiConfig) return;
    
    const fetchData = async () => {
      setLoading(true);
      try {
        const response = await fetch(config.apiConfig.url, {
          method: config.apiConfig.method,
          headers: config.apiConfig.headers,
          body: JSON.stringify(config.apiConfig.body),
        });
        const json = await response.json();
        
        // 应用数据映射
        const mappedData = applyDataMapping(json, config.dataMapping);
        setData(mappedData);
      } catch (err) {
        setError(err);
      } finally {
        setLoading(false);
      }
    };
    
    fetchData();
    
    // 定时刷新
    if (config.apiConfig.refreshInterval) {
      const timer = setInterval(fetchData, config.apiConfig.refreshInterval * 1000);
      return () => clearInterval(timer);
    }
  }, [config]);
  
  return { data, loading, error };
}
```


**Step 3**: 修改 Render 组件

- 文件：`src/components/Editor/Render.tsx`
- 集成 `useDataSource` Hook
- 根据返回数据更新图表配置

**Step 4**: 扩展 SettingBar 配置面板

- 文件：`src/components/Editor/Tools/SettingBar.tsx`
- 新增"数据源"配置区域
- 表单字段：URL、请求方法、请求头、刷新间隔
- 提供"测试连接"功能

**Step 5**: 数据映射配置UI

- 可视化配置：API响应字段 → 图表数据字段
- 支持 JSONPath 表达式（如 `data.items[*].value`）
- 实时预览数据结构

#### 3.3.3 安全考虑

- CORS处理：提供代理服务或配置提示
- 请求限流：防止频繁请求
- 错误处理：友好的错误提示
- 凭证管理：支持Token/API Key配置（加密存储）

### 3.4 项目导出功能（优先级：低）

#### 3.4.1 导出内容

导出为完整的React项目，包含：

```
exported-project/
├── public/
│   └── index.html
├── src/
│   ├── components/      # 使用到的所有组件
│   ├── config/          # 图表配置
│   ├── hooks/           # useDataSource等
│   ├── assets/          # 图片资源
│   ├── App.tsx          # 主应用（基于Schema渲染）
│   └── main.tsx         # 入口文件
├── package.json         # 依赖列表
├── vite.config.ts       # Vite配置
└── README.md            # 使用说明
```

#### 3.4.2 实现步骤

**Step 1**: 创建项目导出工具

- 文件：`src/utils/exportProject.ts`
```typescript
function exportProject(schema: ScreenTemplate, components: Map<string, ChartAttribute>) {
  // 1. 生成组件代码
  const componentFiles = generateComponentFiles(components);
  
  // 2. 生成配置文件
  const configFiles = generateConfigFiles(schema);
  
  // 3. 生成App.tsx（渲染器）
  const appCode = generateAppCode(schema);
  
  // 4. 生成package.json
  const packageJson = generatePackageJson();
  
  // 5. 打包为zip
  const zip = createZip({
    'src/App.tsx': appCode,
    'src/config/schema.json': JSON.stringify(schema),
    'package.json': packageJson,
    ...componentFiles,
    ...configFiles,
  });
  
  return zip;
}
```


**Step 2**: 代码生成器

- Schema → React组件代码
- 使用模板引擎（如 Handlebars）
- 支持代码格式化（Prettier）

**Step 3**: 添加导出按钮

- 位置：编辑器顶部工具栏
- 功能：点击后下载zip文件
- 提示：导出后的使用说明

**Step 4**: 导出项目运行时

- 创建独立的渲染器组件
- 复用项目核心渲染逻辑
- 确保导出项目可独立运行

#### 3.4.3 导出优化

- **按需导出**：只包含使用到的组件
- **依赖优化**：最小化依赖包
- **环境配置**：提供开发/生产环境配置
- **部署指南**：生成部署说明文档

### 3.5 区域框尺寸调整功能

#### 3.5.1 功能说明

为配合空模板和自由布局，需要支持：

- 选中组件后显示调整手柄
- 支持8个方向调整尺寸
- 支持移动位置
- 支持旋转（可选）

#### 3.5.2 实现方式

使用 `react-rnd` 库或自实现：

```typescript
import { Rnd } from 'react-rnd';

function ResizableArea({ area, onUpdate }) {
  return (
    <Rnd
      size={{ width: area.width, height: area.height }}
      position={{ x: area.left, y: area.top }}
      onDragStop={(e, d) => onUpdate({ left: d.x, top: d.y })}
      onResizeStop={(e, direction, ref, delta, position) => {
        onUpdate({
          width: ref.offsetWidth,
          height: ref.offsetHeight,
          ...position,
        });
      }}
    >
      {/* 组件内容 */}
    </Rnd>
  );
}
```

## 四、实施计划

### 阶段一：基础架构升级（2-3周）

1. **类型系统扩展**

   - [ ] 扩展模板和组件类型定义
   - [ ] 添加数据源配置类型
   - [ ] 更新Store类型

2. **空模板实现**

   - [ ] 创建空模板配置
   - [ ] 实现自由布局容器
   - [ ] 实现拖拽放置逻辑
   - [ ] 添加组件调整功能

3. **基础组件开发**

   - [ ] 实现6个基础组件
   - [ ] 添加组件缩略图
   - [ ] 集成到组件选择器
   - [ ] 配置默认属性

### 阶段二：数据绑定功能（2-3周）

4. **数据源系统**

   - [ ] 实现useDataSource Hook
   - [ ] 扩展Render组件支持数据源
   - [ ] 开发数据源配置UI
   - [ ] 实现数据映射功能
   - [ ] 添加测试连接功能

5. **配置面板增强**

   - [ ] 新增数据源配置区域
   - [ ] 实现请求配置表单
   - [ ] 添加数据预览功能
   - [ ] 优化配置交互

### 阶段三：导出功能（2周）

6. **导出工具开发**

   - [ ] 实现Schema转代码生成器
   - [ ] 创建项目模板
   - [ ] 实现文件打包功能
   - [ ] 添加导出UI

7. **测试与优化**

   - [ ] 测试导出项目可运行性
   - [ ] 优化代码生成质量
   - [ ] 编写使用文档

### 阶段四：测试与发布（1周）

8. **集成测试**

   - [ ] 功能测试
   - [ ] 性能测试
   - [ ] 兼容性测试

9. **文档编写**

   - [ ] 用户使用手册
   - [ ] 开发者文档
   - [ ] API文档

## 五、技术风险与对策

### 5.1 风险评估

| 风险项 | 级别 | 影响 | 对策 |

|--------|------|------|------|

| 自由布局性能问题 | 中 | 大量组件时卡顿 | 虚拟化渲染、懒加载 |

| 数据源跨域问题 | 高 | 无法请求外部API | 提供代理服务 |

| 导出代码质量 | 中 | 生成代码不可用 | 充分测试、代码审查 |

| 兼容性问题 | 低 | 旧版本数据迁移 | 版本管理、迁移脚本 |

### 5.2 性能优化

1. **渲染优化**

   - 使用React.memo避免不必要渲染
   - 虚拟滚动（react-window）
   - 按需加载组件

2. **数据请求优化**

   - 请求去重
   - 响应缓存
   - 请求合并

3. **导出优化**

   - 代码压缩
   - Tree shaking
   - 异步加载

## 六、兼容性处理

### 6.1 现有项目兼容

- 保持现有Grid模板完全兼容
- 新增 `layoutMode` 字段作为区分
- 提供模板升级工具

### 6.2 数据迁移

```typescript
// 升级旧版Schema
function migrateSchema(oldSchema: any): ScreenTemplate {
  return {
    ...oldSchema,
    layoutMode: oldSchema.layoutMode || 'grid', // 默认为grid
    version: 2,
  };
}
```

## 七、预期成果

完成升级后，NebulaScreen将具备：

✅ **更灵活的布局能力** - 支持自由拖拽和网格布局两种模式

✅ **更丰富的组件库** - 图表+基础组件，满足多样化需求

✅ **真实数据展示** - 支持API数据绑定和实时刷新

✅ **独立部署能力** - 可导出为独立React项目

**关键指标**：

- 组件数量：从7类图表 → 7类图表 + 6个基础组件
- 布局模式：从1种 → 2种（Grid + Free）
- 数据源：从静态数据 → 静态+API动态数据
- 交付形式：从平台内预览 → 平台内预览 + 独立项目导出

## 八、后续规划

本次升级完成后，可进一步扩展：

1. **组件市场**：用户可上传/下载自定义组件
2. **数据转换器**：可视化配置数据转换逻辑
3. **主题系统**：一键切换整体配色主题
4. **协作功能**：多人实时编辑
5. **版本管理**：项目历史版本管理和回滚

### To-dos

- [ ] 扩展类型系统 - 添加自由布局、数据源等类型定义
- [ ] 实现空模板功能 - 自由布局容器、拖拽放置、尺寸调整
- [ ] 开发6个基础组件 - 文本、标题、图片、时间、滚动文字、容器
- [ ] 集成基础组件到选择器 - 新增分类、缩略图、配置
- [ ] 实现数据源Hook - useDataSource、请求管理、数据映射
- [ ] 扩展Render组件支持数据源 - 集成Hook、动态数据更新
- [ ] 开发数据源配置UI - 配置表单、测试连接、数据预览
- [ ] 实现代码生成器 - Schema转React代码、项目文件生成
- [ ] 实现项目打包 - 生成zip、添加依赖、配置文件
- [ ] 添加导出功能UI - 导出按钮、下载、使用说明
- [ ] 集成测试与优化 - 功能测试、性能优化、兼容性测试
- [ ] 编写文档 - 用户手册、开发文档、API文档