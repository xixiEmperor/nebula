# 环境配置说明

## 环境变量配置

项目使用环境变量来管理配置。请在项目根目录创建 `.env` 文件。

### 创建环境变量文件

复制以下内容到 `.env` 文件:

```env
# 应用配置
PORT=3000

# 数据库配置
MONGODB_URI=mongodb://localhost:27017/nebula-nest

# JWT配置
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRES_IN=7d

# 密码加密轮次
BCRYPT_SALT_ROUNDS=10
```

### 配置项说明

#### 应用配置

- **PORT**: 应用运行端口,默认为 3000
  - 可选值: 任意可用端口号

#### 数据库配置

- **MONGODB_URI**: MongoDB数据库连接URI
  - 本地开发: `mongodb://localhost:27017/nebula-nest`
  - 远程MongoDB: `mongodb://username:password@host:port/database`
  - MongoDB Atlas: `mongodb+srv://username:password@cluster.mongodb.net/database`

#### JWT配置

- **JWT_SECRET**: JWT签名密钥
  - ⚠️ **重要**: 生产环境必须更改为复杂的随机字符串
  - 建议使用至少32位的随机字符串
  - 可以使用以下命令生成:
    ```bash
    node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
    ```

- **JWT_EXPIRES_IN**: Token过期时间
  - 格式: 数字+单位
  - 单位选项:
    - `s`: 秒
    - `m`: 分钟
    - `h`: 小时
    - `d`: 天
  - 示例: `7d` (7天), `24h` (24小时), `30m` (30分钟)

#### 密码加密配置

- **BCRYPT_SALT_ROUNDS**: bcrypt加密轮次
  - 默认值: 10
  - 范围: 4-31
  - 数值越大越安全,但加密时间越长
  - 推荐值: 10-12

---

## 环境配置最佳实践

### 开发环境

创建 `.env` 文件 (已在 .gitignore 中):

```env
PORT=3000
MONGODB_URI=mongodb://localhost:27017/nebula-nest-dev
JWT_SECRET=dev-secret-key-for-testing-only
JWT_EXPIRES_IN=1d
BCRYPT_SALT_ROUNDS=10
```

### 生产环境

创建 `.env.local` 文件或使用环境变量:

```env
PORT=3000
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/nebula-nest-prod
JWT_SECRET=生成的复杂随机字符串
JWT_EXPIRES_IN=7d
BCRYPT_SALT_ROUNDS=12
```

### 测试环境

创建 `.env.test` 文件:

```env
PORT=3001
MONGODB_URI=mongodb://localhost:27017/nebula-nest-test
JWT_SECRET=test-secret-key
JWT_EXPIRES_IN=1h
BCRYPT_SALT_ROUNDS=4
```

---

## 安全建议

1. **永远不要提交 `.env` 文件到版本控制系统**
   - 已在 `.gitignore` 中配置

2. **使用强密钥**
   - 生产环境的 `JWT_SECRET` 必须使用强随机字符串
   - 定期更换密钥

3. **限制Token有效期**
   - 根据业务需求设置合适的过期时间
   - 敏感操作考虑使用短期token

4. **保护数据库连接**
   - 使用强密码
   - 限制数据库访问IP
   - 启用SSL/TLS连接

5. **使用不同的环境配置**
   - 开发、测试、生产环境使用不同的配置
   - 避免在生产环境使用开发配置

---

## 配置加载优先级

应用会按以下顺序加载环境变量文件:

1. `.env.local` (最高优先级)
2. `.env`

如果环境变量在系统中已设置,会覆盖文件中的配置。

---

## 故障排查

### 无法连接数据库

检查:
- MongoDB服务是否启动
- `MONGODB_URI` 配置是否正确
- 网络连接是否正常
- 防火墙是否阻止连接

### JWT认证失败

检查:
- Token是否已过期
- `JWT_SECRET` 在不同环境是否一致
- 请求头中是否正确携带了 Authorization

### 端口被占用

检查:
- 修改 `PORT` 配置为其他可用端口
- 或停止占用当前端口的进程

---

## 环境变量验证

应用启动时会自动验证必需的环境变量。如果缺少必需配置,会使用默认值或报错。

查看当前配置:
```bash
npm run dev
```

启动日志会显示实际使用的配置值(敏感信息会被隐藏)。

